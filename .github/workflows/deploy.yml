name: Deploy to VPS

on:
  push:
    branches: [ main, master ]  # Trigger khi push vÃ o branch main hoáº·c master

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to VPS
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT }}
        script: |
          echo "ðŸš€ Starting deployment..."
          
          # Navigate to project directory
          cd /var/www/KL
          
          # Pull latest code
          echo "ðŸ“¥ Pulling latest code..."
          git pull origin main
          
          # Update API Backend
          echo "ðŸ”„ Updating API Backend..."
          cd api
          npm install --production
          
          # Update AI Service
          echo "ðŸ”„ Updating AI Service..."
          cd ../ai
          source venv/bin/activate
          pip install -r requirements.txt
          
          # Build and Deploy Frontend
          echo "ðŸ”„ Building and Deploying Frontend..."
          cd ../cli
          npm install
          npm run build
          
          # Copy built files to web directory
          sudo cp -r dist/cli/browser/* /var/www/html/
          sudo mv /var/www/html/index.csr.html /var/www/html/index.html 2>/dev/null || true
          sudo chown -R www-data:www-data /var/www/html/
          
          # Restart services
          echo "ðŸ”„ Restarting services..."
          pm2 restart api-backend
          pm2 restart ai-service
          
          # Check service status
          echo "âœ… Deployment completed!"
          pm2 status
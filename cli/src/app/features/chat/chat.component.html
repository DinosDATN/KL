<!-- Main Chat Layout -->
<div class="chat-container flex bg-gray-100 dark:bg-gray-900 h-screen">
  <!-- Chat Sidebar -->
  <div [ngClass]="{
      'w-80 flex-shrink-0 border-r border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 flex flex-col':
        !isMobileView,
      'fixed inset-y-0 left-0 z-50 w-80 bg-white dark:bg-gray-800 shadow-xl transform transition-transform flex flex-col':
        isMobileView,
      'translate-x-0': showSidebar,
      '-translate-x-full': isMobileView && !showSidebar
    }">
    <!-- Sidebar Header with Mode Tabs -->
    <div class="p-4 border-b border-gray-200 dark:border-gray-700">
      <div class="flex space-x-1 mb-4 bg-gray-100 dark:bg-gray-700 p-1 rounded-lg">
        <button (click)="setChatMode('groups')" [class.bg-white]="chatMode === 'groups' && !themeService.isDarkMode()"
          [class.bg-gray-800]="chatMode === 'groups' && themeService.isDarkMode()"
          [class.text-blue-600]="chatMode === 'groups'" [class.shadow-sm]="chatMode === 'groups'" class="flex-1 px-3 py-2 text-sm font-medium rounded-md transition-all text-center
                 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300">
          Nhóm
        </button>
        <button (click)="setChatMode('private')" [class.bg-white]="chatMode === 'private' && !themeService.isDarkMode()"
          [class.bg-gray-800]="chatMode === 'private' && themeService.isDarkMode()"
          [class.text-blue-600]="chatMode === 'private'" [class.shadow-sm]="chatMode === 'private'" class="flex-1 px-3 py-2 text-sm font-medium rounded-md transition-all text-center
                 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300">
          Riêng tư
        </button>
        <button (click)="setChatMode('friends')" [class.bg-white]="chatMode === 'friends' && !themeService.isDarkMode()"
          [class.bg-gray-800]="chatMode === 'friends' && themeService.isDarkMode()"
          [class.text-blue-600]="chatMode === 'friends'" [class.shadow-sm]="chatMode === 'friends'" class="flex-1 px-3 py-2 text-sm font-medium rounded-md transition-all text-center
                 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300">
          Bạn bè
        </button>
      </div>

      <!-- Friends Sub-tabs -->
      <div *ngIf="chatMode === 'friends'" class="flex space-x-1 bg-gray-50 dark:bg-gray-600 p-1 rounded-lg">
        <button (click)="setFriendsTab('list')" [class.bg-white]="friendsTab === 'list' && !themeService.isDarkMode()"
          [class.bg-gray-700]="friendsTab === 'list' && themeService.isDarkMode()"
          [class.text-blue-600]="friendsTab === 'list'" [class.shadow-sm]="friendsTab === 'list'" class="flex-1 px-2 py-1 text-xs font-medium rounded transition-all text-center
                 text-gray-600 dark:text-gray-300 hover:text-gray-800 dark:hover:text-gray-100">
          Danh sách
        </button>
        <button (click)="setFriendsTab('requests')"
          [class.bg-white]="friendsTab === 'requests' && !themeService.isDarkMode()"
          [class.bg-gray-700]="friendsTab === 'requests' && themeService.isDarkMode()"
          [class.text-blue-600]="friendsTab === 'requests'" [class.shadow-sm]="friendsTab === 'requests'" class="flex-1 px-2 py-1 text-xs font-medium rounded transition-all text-center
                 text-gray-600 dark:text-gray-300 hover:text-gray-800 dark:hover:text-gray-100">
          Lời mời
        </button>
        <button (click)="setFriendsTab('search')"
          [class.bg-white]="friendsTab === 'search' && !themeService.isDarkMode()"
          [class.bg-gray-700]="friendsTab === 'search' && themeService.isDarkMode()"
          [class.text-blue-600]="friendsTab === 'search'" [class.shadow-sm]="friendsTab === 'search'" class="flex-1 px-2 py-1 text-xs font-medium rounded transition-all text-center
                 text-gray-600 dark:text-gray-300 hover:text-gray-800 dark:hover:text-gray-100">
          Tìm kiếm
        </button>
      </div>
    </div>

    <!-- Sidebar Content -->
    <div class="flex-1 overflow-hidden min-w-[355px]">
      <!-- Group Chat Sidebar -->
      <div *ngIf="chatMode === 'groups'" class="h-full">
        <app-chat-sidebar [rooms]="getFilteredRooms()" [currentUser]="currentUser!" [selectedRoom]="selectedRoom"
          [searchTerm]="searchTerm" [onlineUsers]="onlineUsers" [getUser]="getUser.bind(this)"
          [getRoomMembers]="getRoomMembers.bind(this)" (roomSelected)="onRoomSelected($event)"
          (createGroup)="onCreateGroup()" (searchChanged)="searchTerm = $event"></app-chat-sidebar>
      </div>

      <!-- Private Chat Mode -->
      <div *ngIf="chatMode === 'private'" class="h-full p-4">
        <app-private-chat-sidebar [listFriends]="getFriendsList()" [searchTerm]="searchPrivateChatTerm"
          (searchChanged)="searchPrivateChatTerm = $event">
        </app-private-chat-sidebar>
      </div>

      <!-- Friends Management -->
      <div *ngIf="chatMode === 'friends'" class="h-full">
        <div *ngIf="friendsTab === 'list'" class="h-full p-4">
          <app-friends-list (startPrivateChat)="onStartPrivateChat($event)"></app-friends-list>
        </div>

        <div *ngIf="friendsTab === 'requests'" class="h-full p-4">
          <app-friend-requests></app-friend-requests>
        </div>

        <div *ngIf="friendsTab === 'search'" class="h-full p-4">
          <app-user-search></app-user-search>
        </div>
      </div>
    </div>
  </div>

  <!-- Mobile Sidebar Overlay -->
  <div *ngIf="isMobileView && showSidebar" class="fixed inset-0 z-40 bg-black bg-opacity-50" (click)="toggleSidebar()">
  </div>

  <!-- Main Chat Area -->
  <div class="chat-main-area flex-1">
    <!-- Mobile Header -->
    <div *ngIf="isMobileView" class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 p-4">
      <div class="flex items-center justify-between">
        <button (click)="toggleSidebar()"
          class="p-2 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
        <h1 class="text-lg font-semibold text-gray-900 dark:text-white">
          Chat - {{chatMode === 'groups' ? 'Nhóm' : chatMode === 'private' ? 'Riêng tư' : 'Bạn bè'}}
        </h1>
        <div class="w-10"></div>
        <!-- Spacer for centering -->
      </div>
    </div>

    <!-- Chat Content -->
    <div class="flex-1 min-h-0 position-relative">
      <ng-container *ngIf="currentUser; else notAuthenticated">
        <!-- Group Chat Mode -->
        <ng-container *ngIf="chatMode === 'groups'">
          <ng-container *ngIf="selectedRoom; else noChatSelected">
            <!-- Chat Main Component -->
            <app-chat-main class="h-full w-full" [room]="selectedRoom" [messages]="getRoomMessages(selectedRoom.id)"
              [currentUser]="currentUser!" [roomMembers]="getRoomMembers(selectedRoom.id)" [reactions]="reactions"
              [typingUsers]="typingUsers" [isRoomAdmin]="
                currentUser ? isRoomAdmin(selectedRoom.id, currentUser.id) : false
              " [allUsers]="users" [paginationCallbacks]="getPaginationCallbacks()"
              (sendMessage)="onSendMessage($event)" (reactToMessage)="
                onReactToMessage($event.messageId, $event.reactionType)
              " (updateChatSettings)="onUpdateChatSettings($event)" (handleMemberAction)="onHandleMemberAction($event)"
              (deleteRoom)="onDeleteRoom($event)" (leaveRoom)="onLeaveRoom($event)"
              (loadOlderMessages)="onLoadOlderMessages()" [getUser]="getUser.bind(this)"
              [getMessageReactions]="getMessageReactions.bind(this)"></app-chat-main>
          </ng-container>
        </ng-container>

        <!-- Private Chat Mode -->
        <ng-container *ngIf="chatMode === 'private'">
          <app-private-chat class="h-full w-full"></app-private-chat>
        </ng-container>

        <!-- Friends Management Mode -->
        <ng-container *ngIf="chatMode === 'friends'">
          <div class="flex-1 flex items-center justify-center bg-gray-50 dark:bg-gray-900">
            <div class="text-center max-w-md mx-auto px-6">
              <div
                class="w-24 h-24 mx-auto mb-8 bg-gradient-to-br from-green-100 to-blue-100 dark:from-green-900 dark:to-blue-900 rounded-full flex items-center justify-center">
                <svg class="w-12 h-12 text-green-600 dark:text-green-400" fill="none" stroke="currentColor"
                  viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-2.239"></path>
                </svg>
              </div>
              <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-3">Quản lý bạn bè</h2>
              <p class="text-lg text-gray-600 dark:text-gray-400 leading-relaxed">Sử dụng thanh bên để quản lý bạn bè,
                lời mời và tìm kiếm người dùng mới</p>
            </div>
          </div>
        </ng-container>
      </ng-container>
    </div>
  </div>
</div>

<!-- No Chat Selected State -->
<ng-template #noChatSelected>
  <div class="flex-1 flex items-center justify-center bg-gray-50 dark:bg-gray-900">
    <div class="text-center max-w-md mx-auto px-6">
      <div
        class="w-24 h-24 mx-auto mb-8 bg-gradient-to-br from-blue-100 to-purple-100 dark:from-blue-900 dark:to-purple-900 rounded-full flex items-center justify-center">
        <svg class="w-12 h-12 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z">
          </path>
        </svg>
      </div>

      <div class="space-y-3">
        <h2 class="text-3xl font-bold text-gray-900 dark:text-white">
          Chào mừng đến với Chat
        </h2>
        <p class="text-lg text-gray-600 dark:text-gray-400 leading-relaxed">
          Chọn một cuộc trò chuyện để bắt đầu hoặc tạo nhóm mới
        </p>
      </div>

      <div class="flex flex-col sm:flex-row gap-4 justify-center mt-8">
        <button *ngIf="!isMobileView && !showSidebar" (click)="toggleSidebar()"
          class="inline-flex items-center gap-2 px-6 py-3 bg-gray-600 hover:bg-gray-700 text-white font-medium rounded-xl transition-all duration-200 hover:scale-105 shadow-lg">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z">
            </path>
          </svg>
          Xem cuộc trò chuyện
        </button>

        <button (click)="onCreateGroup()"
          class="inline-flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-medium rounded-xl transition-all duration-200 hover:scale-105 shadow-lg">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
          </svg>
          Tạo nhóm mới
        </button>
      </div>
    </div>
  </div>
</ng-template>

<!-- Not Authenticated State -->
<ng-template #notAuthenticated>
  <div class="flex-1 flex items-center justify-center bg-gray-50 dark:bg-gray-900">
    <div class="text-center max-w-md mx-auto px-6">
      <div
        class="w-24 h-24 mx-auto mb-8 bg-gradient-to-br from-red-100 to-orange-100 dark:from-red-900 dark:to-orange-900 rounded-full flex items-center justify-center">
        <svg class="w-12 h-12 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M12 15v2m0 0v2m0-2h2m-2 0h-2m8-6V9a4 4 0 00-8 0v2m0 0V9a4 4 0 014-4 4 4 0 014 4v2"></path>
        </svg>
      </div>

      <div class="space-y-3">
        <h2 class="text-3xl font-bold text-gray-900 dark:text-white">
          Đăng nhập để sử dụng Chat
        </h2>
        <p class="text-lg text-gray-600 dark:text-gray-400 leading-relaxed">
          Bạn cần đăng nhập để truy cập tính năng chat
        </p>
      </div>

      <div class="flex flex-col sm:flex-row gap-4 justify-center mt-8">
        <button (click)="navigateToLogin()"
          class="inline-flex items-center gap-2 px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-xl transition-all duration-200 hover:scale-105 shadow-lg">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path>
          </svg>
          Đăng nhập
        </button>

        <button (click)="navigateToRegister()"
          class="inline-flex items-center gap-2 px-6 py-3 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 font-medium rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700 transition-all duration-200 hover:scale-105 shadow-lg">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
          </svg>
          Đăng ký
        </button>
      </div>
    </div>
  </div>
</ng-template>

<!-- Create Group Modal -->
<app-create-group-modal *ngIf="showCreateGroupModal && currentUser" [currentUser]="currentUser"
  (groupCreated)="onGroupCreated($event)" (modalClosed)="onCloseModal()"></app-create-group-modal>

<!-- Notification Toasts -->
<app-notification-toast></app-notification-toast>
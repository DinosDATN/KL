<!-- ChatAI Widget Container -->
<div class="chat-ai-widget" [ngClass]="getWidgetPosition()">
  
  <!-- Chat Toggle Button/Icon -->
  <div class="chat-toggle-button" 
       (click)="toggleChat()" 
       [class.active]="isOpen"
       title="Tr·ª£ l√Ω AI - Click ƒë·ªÉ chat">
    
    <!-- Chat Icon -->
    <div class="chat-icon" *ngIf="!isOpen">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 2C6.48 2 2 6.48 2 12C2 13.54 2.38 14.99 3.06 16.26L2 22L7.74 20.94C9.01 21.62 10.46 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2Z" 
              fill="currentColor"/>
        <path d="M8 12H8.01M12 12H12.01M16 12H16.01" 
              stroke="white" 
              stroke-width="2" 
              stroke-linecap="round"/>
      </svg>
      
      <!-- Notification dot for unread messages -->
      <div class="notification-dot" *ngIf="messages.length > 1"></div>
    </div>

    <!-- Close Icon -->
    <div class="close-icon" *ngIf="isOpen">
      <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M15 5L5 15M5 5L15 15" 
              stroke="currentColor" 
              stroke-width="2" 
              stroke-linecap="round"/>
      </svg>
    </div>
  </div>

  <!-- Chat Window -->
  <div class="chat-window" 
       [class.open]="isOpen" 
       [class.mobile]="getWidgetPosition() === 'mobile'">
    
    <!-- Chat Header -->
    <div class="chat-header">
      <div class="chat-title">
        <div class="ai-avatar">ü§ñ</div>
        <div class="title-text">
          <h3>Tr·ª£ l√Ω AI</h3>
          <p class="status" [class.loading]="isLoading">
            {{ isLoading ? 'ƒêang tr·∫£ l·ªùi...' : 'S·∫µn s√†ng h·ªó tr·ª£ b·∫°n' }}
          </p>
        </div>
      </div>
      
      <div class="chat-actions">
        <button class="action-btn" 
                (click)="clearChat()" 
                title="X√≥a l·ªãch s·ª≠ chat"
                [disabled]="isLoading">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
            <path d="M2 4H14M5.5 4V2.5C5.5 1.67 6.17 1 7 1H9C9.83 1 10.5 1.67 10.5 2.5V4M7 7V11M9 7V11M3 4L3.5 13C3.5 13.83 4.17 14.5 5 14.5H11C11.83 14.5 12.5 13.83 12.5 13L13 4H3Z" 
                  stroke="currentColor" 
                  stroke-width="1" 
                  stroke-linecap="round"/>
          </svg>
        </button>
        
        <button class="action-btn" 
                (click)="exportChat()" 
                title="Xu·∫•t l·ªãch s·ª≠ chat"
                [disabled]="messages.length <= 1">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
            <path d="M8 11V1M8 1L5 4M8 1L11 4M2 11V13C2 13.55 2.45 14 3 14H13C13.55 14 14 13.55 14 13V11" 
                  stroke="currentColor" 
                  stroke-width="1" 
                  stroke-linecap="round"/>
          </svg>
        </button>
        
        <button class="close-btn" (click)="closeChat()" title="ƒê√≥ng chat">
          <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
            <path d="M11 3L3 11M3 3L11 11" 
                  stroke="currentColor" 
                  stroke-width="1.5" 
                  stroke-linecap="round"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- Chat Messages -->
    <div class="chat-messages">
      <div class="messages-container">
        
        <!-- Individual Messages -->
        <div class="message" 
             *ngFor="let message of messages; trackBy: trackByMessageId"
             [ngClass]="{
               'user': message.isUser,
               'ai': !message.isUser,
               'typing': isTypingMessage(message)
             }">
          
          <div class="message-content">
            <!-- Message Avatar -->
            <div class="message-avatar">
              <span *ngIf="message.isUser">üë§</span>
              <span *ngIf="!message.isUser">ü§ñ</span>
            </div>
            
            <!-- Message Bubble -->
            <div class="message-bubble">
              <!-- Typing indicator -->
              <div class="typing-indicator" *ngIf="isTypingMessage(message)">
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
              </div>
              
              <!-- Normal message text -->
              <div class="message-text" 
                   *ngIf="!isTypingMessage(message)"
                   [innerHTML]="formatMessageText(message.text)">
              </div>
              
              <!-- Message timestamp -->
              <div class="message-time" *ngIf="!isTypingMessage(message)">
                {{ getMessageTime(message) }}
              </div>
            </div>
          </div>
        </div>

        <!-- Quick Questions -->
        <div class="quick-questions" *ngIf="showQuickQuestions && messages.length <= 1">
          <div class="quick-questions-title">üí° C√¢u h·ªèi g·ª£i √Ω:</div>
          <div class="quick-question-buttons">
            <button class="quick-question-btn" 
                    *ngFor="let question of quickQuestions"
                    (click)="sendQuickQuestion(question)"
                    [disabled]="isLoading">
              {{ question }}
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Chat Input -->
    <div class="chat-input-container">
      <div class="input-wrapper">
        <textarea class="chat-input" 
                  [(ngModel)]="currentMessage"
                  (keydown)="onKeyPress($event)"
                  [disabled]="isLoading"
                  placeholder="Nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n..."
                  rows="1"
                  maxlength="1000">
        </textarea>
        
        <button class="send-button" 
                (click)="sendMessage()"
                [disabled]="!currentMessage.trim() || isLoading"
                title="G·ª≠i tin nh·∫Øn (Enter)">
          
          <!-- Loading spinner -->
          <div class="loading-spinner" *ngIf="isLoading">
            <div class="spinner"></div>
          </div>
          
          <!-- Send icon -->
          <svg *ngIf="!isLoading" width="20" height="20" viewBox="0 0 20 20" fill="none">
            <path d="M18 10L2 2L6 10L2 18L18 10Z" 
                  fill="currentColor"/>
          </svg>
        </button>
      </div>
      
      <!-- Character count -->
      <div class="character-count" 
           [class.warning]="currentMessage.length > 800"
           [class.error]="currentMessage.length >= 1000">
        {{ currentMessage.length }}/1000
      </div>
    </div>

    <!-- Chat Footer -->
    <div class="chat-footer">
      <div class="footer-text">
        ƒê∆∞·ª£c h·ªó tr·ª£ b·ªüi AI ‚Ä¢ 
        <span class="health-indicator" (click)="checkAIHealth()">
          Tr·∫°ng th√°i: Ho·∫°t ƒë·ªông
        </span>
      </div>
    </div>
  </div>
</div>